<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<link rel="stylesheet" href=".//css/style.css">
<title>HiboChat</title>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@600&display=swap');
</style>
</head>
<body>

<!-- コンテンツ表示画面 -->

<div>
    <div id="output" style="overflow: auto; height: 300px"></div>
    <div> NAME <input type="text" id="uname"> </div>
    <div>
        <textarea id="text" cols="30" rows="10"></textarea>
        <button id="send">Send Message</button>
    </div>
</div>
<!--/ コンテンツ表示画面 -->



<!-- JQuery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<!-- JQuery -->


<!--** 以下Firebase **-->
<script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-app.js";
    import { getDatabase, ref, push, set, onChildAdded, remove, onChildRemoved } 
    from "https://www.gstatic.com/firebasejs/9.21.0/firebase-database.js";
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries
  
  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyCKRKMI2wbQGRbxAWsuiep8F4-2EY5GVwo",
    authDomain: "hibo-chat-dbcfb.firebaseapp.com",
    projectId: "hibo-chat-dbcfb",
    storageBucket: "hibo-chat-dbcfb.appspot.com",
    messagingSenderId: "627476140809",
    appId: "1:627476140809:web:22e6a48d5d96872b9639d8"
  };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app)
    const dbRef = ref(db,"chat")

    $("#send").on("click",function(){
        const msg = {
        uname : $("#uname").val(),
        text : $("#text").val(),
        time : new Date().toLocaleString() //送信時刻を追加
        }
        const newPostRef = push(dbRef); //ユニークキーを生成
        set(newPostRef,msg);
    });

    onChildAdded(dbRef,function(data){
        const msg = data.val ();
        const key = data.key; //ユニークキー
        let h = '<p class="' + (msg.name === $("#uname").val()? 'm-msg' : 'o-msg' )+ '">';
            h += msg.uname;
            h += '<br>'
            h += msg.text;
            h += '<br>'
            h += '<small>' + msg.time + '</small>' ;
            h += '<button class = "delete-btn" data-key ="'+ key +'">Delete</button>';
            h += '</p>'
            $("#output").append(h);
            
            //最下部にスクロールする
            const output = document.getElementById('output');
            output.scrollTop = output.scrollHeight;
    })
    
    $(document).on("click",".delete-btn",function(){
        const key = $(this).data("key");
        remove(ref(db,"chat/" + key)); //該当するメッセージをfirebaseから削除
        $(this).parent().remove(); //該当するメッセージをHTML上から削除
    })
    
  </script>
</body>
</html>